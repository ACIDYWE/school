# Исключения. Сокеты

1) Рассмотрели какие ошибки могут появляться в программах.

Условно все ошибки можно разделить на **синтаксические ошибки** (`syntax errors`) и **исключения** (`exceptions`).

---

Как правило **синтаксические ошибки** являются наиболее распространенными и являются фатальными, т.е такими, когда парсер питона не может понять кусочек кода и соответственно совсем нет варианта исполнить этот код и программа завершается с ошибкой.

К синтаксическим ошибкам можно отнести:
<details><summary>некорректное использование специальных слов:</summary>
К примеру, надо не забывать, что python регистрозависимый язык и случайное неправильное написание какого-то [ключевого слова](https://pythonworld.ru/osnovy/klyuchevye-slova-modul-keyword.html)  приведет к ошибке: интерпретатор просто посмотрит, что такого ключевого слова нет и воспримет как переменную, а вы такую переменную не объявляли, так еще и неправильно используете.

```python
>>> some_message = "Hello world!"
>>> i = 10
>>> While i > 0:
  File "<stdin>", line 1
    While i > 0:
          ^
SyntaxError: invalid syntax
```
</details>

<details><summary>забытое ':' после операторов `if` или `while`</summary>

```python
>>> my_list = [1, 6, 5, 4, 7, 8, 9, 10]
>>> 
>>> for number in list
  File "<stdin>", line 1
    for number in list
                     ^
SyntaxError: invalid syntax
```
</details>

<details><summary>неверное количество скобочек в выражениях</summary>

```python
1 def find_roots(a, b, c):
2     D =  b**2 - 4*a*c
3
4     if D < 0:
5         return "There are no real roots"
6     x1 = (-b + D**(0.5) / 2*a
7     x2 = (-b - D**(0.5)) / 2*a
8
9     return x1, x2
10
11 print("ax^2 + bx + c = 0")
12
13 a = int(input("Enter a: "))
14 b = int(input("Enter b: "))
15 c = int(input("Enter c: "))
16 
17 print(find_roots(a, b, c))

File "syntax_errors.py", line 7
    x2 = (-b - D**(0.5)) / 2*a
     ^
SyntaxError: invalid syntax
```

или
```python
>>> print "hello world!"
  File "<stdin>", line 1
    print "Hello world!"
                       ^
SyntaxError: Missing parentheses in call to 'print'
```
</details>

<details><summary>незакрытые кавычки</summary>

```python
1 some_message = "Hello" + "world
2
3 print(some_message)

 File "syntax_errors.py", line 1
    some_message = "Hello" + "world
                                  ^
SyntaxError: EOL while scanning string literal
```

</details>

<details><summary>неправильные отступы</summary>
Да, да, очень важны отступы!

```python
1 x = 1
2   y = 25
3
4 print(x * y)

  File "syntax_errors.py", line 2
    y = 25
    ^
IndentationError: unexpected indent
```
</details>

<details><summary>использование необъявленных переменных</summary>

```python
>>> number_1 = 123
>>> number_2 = 87
>>> 
>>> print(number_1 + numer_2)
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
NameError: name 'numer_2' is not defined
>>> 
```
</details>

<details><summary>некорректная передача аргументов</summary>

```python
>>> def add(a ,b):
...     return a + b
... 
>>> 
>>> 
>>> number_1 = 4
>>> number_2 = 3
>>> 
>>> summ = add(number_1, , number_2)
  File "<stdin>", line 1
    summ = add(number_1, , number_2)
                         ^
SyntaxError: invalid syntax
>>> 

```
</details>

Такие ошибки следует исправлять в исходном коде программы.

---
Но бывают такие ситуации, когда синтаксически выражения и операторы могут быть верными, но ошибка может произойти на этапе исполнения программы, но не являться фатальной. Такие ошибки называют **исключениями**. И их можно научиться обрабатывать, чтобы программа не завершалась, а как-то продолжила работать, например, просто сообщив пользователю об ошибке.

Чуть подробней, чем мы разобрали на занятии, хорошо описано [тут](http://pep8.ru/doc/tutorial-2.6/9.html).

---

2) Сокеты

На занятии познакомились с сокетами и как они работают. 
Отличная [статья с хабра](https://habrahabr.ru/post/149077/) с похожим примером, который делали мы.

Пример кода, который мог у вас получиться:

<details><summary>server.py</summary>

```python
import socket

sock = socket.socket()

HOST = '' # это означает localhost, что тоже самое - 127.0.0.0
PORT = 31337 # в целом можно использовать любой незанятый порт. А из какого диапазона можно выбрать?

try:
	sock.bind((HOST, PORT)) #привязываем адрес и порт
	
  # устанавливаем количество максимальных соединений с сервером и запускаем режим прослушивания
	sock.listen(1) 

	# теперь мы можем установить соединение
	# conn - сокет клиента
	# addr - адрес клиента
	conn, addr = sock.accept()

	print("Connected: ", addr)
  
  # надо помнить, что через сокет мы передаем байты и, чтобы конвертировать строку в байты, мы 
  # можем перед строкой поставить префикс b 
	conn.send(b"You are connected, send smth\n")
	while True:
    # в ответ нам так же приходят байты
		data = conn.recv(1024) 
    # если мы хотим работать как со строкой, то эти байты мы должны конвертировать в символы, 
    # допустим используя кодировку 'utf-8'
		message = data.decode('utf-8')
		print(message)
		if not data or 'quit' in message:
			break

		conn.send(b"Ok, i get it!\n")
	conn.close()
finally:
  # очень важно не забывать закрывать соединение!
	sock.close()
```
</details>

<details><summary>client.py</summary>

```python
import socket
import time

sock = socket.socket()
# адрес и порт СЕРВЕРА, куда мы хотим подключиться
HOST = 'localhost'
PORT = 31337

# подключаемся к серверу по ЕГО адресу и порту
sock.connect((HOST, PORT))

# можем также прислать что-нибудь
sock.send(b'Hi\n')

# помните возникала ошибка и клиент с сервером падали?
# так происходило, потому что код же выполняется быстро и сервер не успевал принять данные.
# а таким способом мы просим клиента подождать всего лишь 1 секунду и дальше принимать и отправлять данные.
time.sleep(1)

# также можем получить какие-то данные
data = sock.recv(1024)
print(data)

sock.send(b'quit\n')

# не забываем закрыть соединение!
sock.close()
```
</details>

Еще раз как это концептуально работает:

1. Сначала запускаете сервер. 
2. Он начинает ждать одно (по нашему коду) соединение. 
3. Потом запускаете клиента. 
4. Клиент выполняет какую-то логику и программа завершается.

---

### Домашнее задание
<details><summary>123 + 4653 = ?</summary>
Используя сокеты написать сервис, который загадывает пользователю арифметические примеры. В случае правильного ответа пользователем на 10 примеров, сервис говорит, что пользователь выиграл и завершает свою работу.

Задача: 
- пока что для простоты будем считать, что к нам будет подключаться только один пользователь.
- каждый пример сначала нумеруется, потом уже идет само арифметическое выражение.
- в ответ от пользователя сервис должен ожидать одно число - ответ на пример.
- если пользователь ответил верно, то даем следующий пример, если неверно, то закрываем подключение с ним и ждем нового пользователя.
- для проверки корректности работы серверной части, необходимо написать клиентскую, которая подключается к серверу и решает правильно 10 заданий и получив ответ, что все верно, завершает соединение.

Пример взаимодействия:
```
user$nc localhost 31337
> Hi! You need to solve 10 arithmetic problems:
1. 23 + 45
68
2. 682 + 47
729
3. 669 * 364
2435
> It's wrong!
user$
```
</details>

<details><summary>Очень грубый бот</summary>
На нашем сервере завёлся очень грубый бот, не мог бы ты немного поработать антиматом?

На каждую фразу бота ответь его же фразой, исправленной так, что
- каждое обычное ругательство заменяется по правилу
  - с корнем "blya": корень заменяется на '\*\*\*', e.g. treblyaq —> tre\*\*\*q
  - с началом на "f" и концом на "ck": слово заменяется на 'f\*\*\*'
- каждое очень обидное ругательство заменяется на r '\*\*\*', где r - род очень обидного ругательства, e.g. очень обидные ругательства 3го рода должны заменться на "*********"
- регистр и пунктуация должны быть сохранены!

Назовем ругательство очень обидным, если оно содержит сразу несколько признаков ругательства: 
- очень обидные ругательства 1 рода начинаются на "f", заканчиваются на "ck" и содержат произвольное количество корней "blya"
- очень обидные ругательства 2 рода содержат ровно 2 корня "blya"
...
- очень обидные ругательства n рода содержат ровно n корней "blya"

Бот живет по адресу `school.sibears.ru:4041`

</details>


